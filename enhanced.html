<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Room Planner - Advanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }

        .main-viewport {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a0a 100%);
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        h2 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #888;
            margin: 20px 0 10px 0;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .furniture-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .furniture-item {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .furniture-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .furniture-item:hover::before {
            left: 100%;
        }

        .furniture-item:hover {
            transform: translateY(-3px);
            border-color: rgba(102, 126, 234, 0.8);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        }

        .furniture-icon {
            font-size: 2rem;
            margin-bottom: 5px;
            display: block;
        }

        .furniture-name {
            font-size: 0.9rem;
            color: #ccc;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: #fff;
            font-size: 0.9rem;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .view-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 15, 0.9);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .view-controls button {
            width: auto;
            padding: 8px 15px;
            margin: 0 5px;
            font-size: 0.8rem;
        }

        .room-editor {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .room-shape-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            min-height: 150px;
            position: relative;
        }

        #shape-canvas {
            width: 100%;
            height: 150px;
            cursor: crosshair;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-panel p {
            font-size: 0.85rem;
            color: #888;
            margin: 5px 0;
            line-height: 1.5;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #667eea;
            font-size: 1.2rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 15, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #888;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shape-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .shape-tools button {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>3D Room Planner</h1>
            
            <h2>Room Shape</h2>
            <div class="room-editor">
                <div class="shape-tools">
                    <button onclick="setRoomShape('rectangle')">Rectangle</button>
                    <button onclick="setRoomShape('L')">L-Shape</button>
                    <button onclick="setRoomShape('custom')">Custom</button>
                </div>
                <div class="room-shape-display">
                    <canvas id="shape-canvas"></canvas>
                </div>
                <button onclick="applyRoomShape()">Apply Shape</button>
            </div>

            <h2>Furniture</h2>
            <div class="furniture-grid">
                <div class="furniture-item" data-type="bed">
                    <span class="furniture-icon">üõèÔ∏è</span>
                    <div class="furniture-name">Bed</div>
                </div>
                <div class="furniture-item" data-type="wardrobe">
                    <span class="furniture-icon">üö™</span>
                    <div class="furniture-name">Wardrobe</div>
                </div>
                <div class="furniture-item" data-type="desk">
                    <span class="furniture-icon">üóÑÔ∏è</span>
                    <div class="furniture-name">Desk</div>
                </div>
                <div class="furniture-item" data-type="chair">
                    <span class="furniture-icon">ü™ë</span>
                    <div class="furniture-name">Chair</div>
                </div>
                <div class="furniture-item" data-type="sofa">
                    <span class="furniture-icon">üõãÔ∏è</span>
                    <div class="furniture-name">Sofa</div>
                </div>
                <div class="furniture-item" data-type="table">
                    <span class="furniture-icon">‚¨ú</span>
                    <div class="furniture-name">Table</div>
                </div>
            </div>

            <h2>Room Settings</h2>
            <div class="control-group">
                <label>Wall Height</label>
                <input type="range" id="wallHeight" min="2" max="5" value="3" step="0.5">
                <span id="wallHeightValue">3m</span>
            </div>

            <div class="control-group">
                <label>Floor Material</label>
                <select id="floorMaterial">
                    <option value="wood">Wood</option>
                    <option value="tiles">Tiles</option>
                    <option value="carpet">Carpet</option>
                    <option value="concrete">Concrete</option>
                </select>
            </div>

            <h2>Actions</h2>
            <button onclick="clearRoom()">Clear Room</button>
            <button onclick="saveLayout()">Save Layout</button>
            <button onclick="loadLayout()">Load Layout</button>
            <button onclick="randomFurniture()">Random Layout</button>

            <div class="info-panel">
                <p><strong>Controls:</strong></p>
                <p>‚Ä¢ Left click + drag: Rotate view</p>
                <p>‚Ä¢ Right click + drag: Pan</p>
                <p>‚Ä¢ Scroll: Zoom in/out</p>
                <p>‚Ä¢ Click furniture to add</p>
                <p>‚Ä¢ Click placed item to select</p>
                <p>‚Ä¢ Delete key: Remove selected</p>
            </div>
        </div>

        <div class="main-viewport">
            <div id="canvas-container">
                <div class="loading">Loading 3D Environment...</div>
            </div>
            
            <div class="view-controls">
                <button onclick="setViewAngle('top')">Top</button>
                <button onclick="setViewAngle('perspective')">Perspective</button>
                <button onclick="setViewAngle('front')">Front</button>
                <button onclick="setViewAngle('side')">Side</button>
            </div>

            <div class="controls-hint">
                Left Mouse: Rotate ‚Ä¢ Right Mouse: Pan ‚Ä¢ Scroll: Zoom
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, controls;
        let room, furniture = [];
        let selectedObject = null;
        let raycaster, mouse;
        let roomShape = [];
        let currentShapeMode = 'rectangle';
        let shapeCanvas, shapeCtx;

        // Initialize Three.js
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.Fog(0x0a0a0a, 10, 50);

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(10, 10, 10);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth - 320, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            const container = document.getElementById('canvas-container');
            container.innerHTML = '';
            container.appendChild(renderer.domElement);

            // Controls setup (custom orbit controls since we can't import)
            setupOrbitControls();

            // Lighting
            setupLighting();

            // Raycaster for mouse interaction
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // Create default room
            createRoom('rectangle');

            // Setup event listeners
            setupEventListeners();

            // Setup shape canvas
            setupShapeCanvas();

            // Start animation
            animate();

            // Remove loading indicator
            document.querySelector('.loading').style.display = 'none';
        }

        function setupOrbitControls() {
            const canvas = renderer.domElement;
            let mouseDown = false;
            let mouseButton = 0;
            let mouseX = 0;
            let mouseY = 0;
            let lon = 0;
            let lat = 0;
            let phi = 0;
            let theta = 0;
            let distance = 20;
            let panX = 0;
            let panY = 0;

            canvas.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseButton = e.button;
                mouseX = e.clientX;
                mouseY = e.clientY;
                e.preventDefault();
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;

                if (mouseButton === 0) { // Left click - rotate
                    lon += (e.clientX - mouseX) * 0.5;
                    lat -= (e.clientY - mouseY) * 0.5;
                    lat = Math.max(-85, Math.min(85, lat));
                } else if (mouseButton === 2) { // Right click - pan
                    panX -= (e.clientX - mouseX) * 0.05;
                    panY += (e.clientY - mouseY) * 0.05;
                }

                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            canvas.addEventListener('mouseup', () => {
                mouseDown = false;
            });

            canvas.addEventListener('wheel', (e) => {
                distance += e.deltaY * 0.01;
                distance = Math.max(5, Math.min(50, distance));
                e.preventDefault();
            });

            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
            });

            // Update camera position
            controls = {
                update: () => {
                    phi = THREE.MathUtils.degToRad(90 - lat);
                    theta = THREE.MathUtils.degToRad(lon);

                    const x = distance * Math.sin(phi) * Math.cos(theta) + panX;
                    const y = distance * Math.cos(phi) + panY;
                    const z = distance * Math.sin(phi) * Math.sin(theta);

                    camera.position.set(x, y, z);
                    camera.lookAt(panX, panY, 0);
                }
            };
        }

        function setupLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
            scene.add(ambientLight);

            // Directional light (sun)
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -15;
            directionalLight.shadow.camera.right = 15;
            directionalLight.shadow.camera.top = 15;
            directionalLight.shadow.camera.bottom = -15;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Point lights for interior lighting
            const pointLight1 = new THREE.PointLight(0x667eea, 0.5, 20);
            pointLight1.position.set(-5, 5, -5);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0x764ba2, 0.5, 20);
            pointLight2.position.set(5, 5, 5);
            scene.add(pointLight2);
        }

        function createRoom(shapeType) {
            // Remove existing room
            if (room) {
                scene.remove(room);
            }

            room = new THREE.Group();

            let floorShape;
            if (shapeType === 'rectangle') {
                floorShape = new THREE.Shape();
                floorShape.moveTo(-5, -5);
                floorShape.lineTo(5, -5);
                floorShape.lineTo(5, 5);
                floorShape.lineTo(-5, 5);
                floorShape.closePath();
            } else if (shapeType === 'L') {
                floorShape = new THREE.Shape();
                floorShape.moveTo(-5, -5);
                floorShape.lineTo(0, -5);
                floorShape.lineTo(0, 0);
                floorShape.lineTo(5, 0);
                floorShape.lineTo(5, 5);
                floorShape.lineTo(-5, 5);
                floorShape.closePath();
            } else if (shapeType === 'custom' && roomShape.length > 2) {
                floorShape = new THREE.Shape();
                floorShape.moveTo(roomShape[0].x, roomShape[0].z);
                for (let i = 1; i < roomShape.length; i++) {
                    floorShape.lineTo(roomShape[i].x, roomShape[i].z);
                }
                floorShape.closePath();
            } else {
                // Default to rectangle
                floorShape = new THREE.Shape();
                floorShape.moveTo(-5, -5);
                floorShape.lineTo(5, -5);
                floorShape.lineTo(5, 5);
                floorShape.lineTo(-5, 5);
                floorShape.closePath();
            }

            // Floor
            const floorGeometry = new THREE.ShapeGeometry(floorShape);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x8B7355,
                roughness: 0.8,
                metalness: 0.1
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            room.add(floor);

            // Walls
            const wallHeight = parseFloat(document.getElementById('wallHeight').value);
            const extrudeSettings = {
                steps: 1,
                depth: wallHeight,
                bevelEnabled: false
            };

            const wallGeometry = new THREE.ExtrudeGeometry(floorShape, extrudeSettings);
            const wallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xf0f0f0,
                side: THREE.BackSide,
                roughness: 0.9,
                metalness: 0.0
            });
            const walls = new THREE.Mesh(wallGeometry, wallMaterial);
            walls.rotation.x = Math.PI / 2;
            walls.position.y = wallHeight / 2;
            walls.castShadow = true;
            walls.receiveShadow = true;
            room.add(walls);

            scene.add(room);
        }

        function createFurniture(type, position) {
            let furnitureGroup = new THREE.Group();
            furnitureGroup.userData.type = type;

            switch(type) {
                case 'bed':
                    createBed(furnitureGroup);
                    break;
                case 'wardrobe':
                    createWardrobe(furnitureGroup);
                    break;
                case 'desk':
                    createDesk(furnitureGroup);
                    break;
                case 'chair':
                    createChair(furnitureGroup);
                    break;
                case 'sofa':
                    createSofa(furnitureGroup);
                    break;
                case 'table':
                    createTable(furnitureGroup);
                    break;
            }

            if (position) {
                furnitureGroup.position.copy(position);
            }

            furniture.push(furnitureGroup);
            scene.add(furnitureGroup);
            return furnitureGroup;
        }

        function createBed(group) {
            // Bed frame
            const frameGeometry = new THREE.BoxGeometry(2, 0.5, 3);
            const frameMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const frame = new THREE.Mesh(frameGeometry, frameMaterial);
            frame.position.y = 0.25;
            frame.castShadow = true;
            group.add(frame);

            // Mattress
            const mattressGeometry = new THREE.BoxGeometry(1.9, 0.3, 2.9);
            const mattressMaterial = new THREE.MeshStandardMaterial({ color: 0xE6E6FA });
            const mattress = new THREE.Mesh(mattressGeometry, mattressMaterial);
            mattress.position.y = 0.65;
            mattress.castShadow = true;
            group.add(mattress);

            // Pillows
            const pillowGeometry = new THREE.BoxGeometry(0.8, 0.2, 0.4);
            const pillowMaterial = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
            
            const pillow1 = new THREE.Mesh(pillowGeometry, pillowMaterial);
            pillow1.position.set(-0.5, 0.9, 1.2);
            group.add(pillow1);
            
            const pillow2 = new THREE.Mesh(pillowGeometry, pillowMaterial);
            pillow2.position.set(.5, 0.9, 1.2);
            group.add(pillow2);
        }

        function createWardrobe(group) {
            // Main body
            const bodyGeometry = new THREE.BoxGeometry(1.5, 2.5, 0.6);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1.25;
            body.castShadow = true;
            group.add(body);

            // Doors
            const doorGeometry = new THREE.BoxGeometry(0.7, 2.3, 0.05);
            const doorMaterial = new THREE.MeshStandardMaterial({ color: 0xA0522D });
            
            const door1 = new THREE.Mesh(doorGeometry, doorMaterial);
            door1.position.set(-0.35, 1.25, 0.33);
            group.add(door1);
            
            const door2 = new THREE.Mesh(doorGeometry, doorMaterial);
            door2.position.set(0.35, 1.25, 0.33);
            group.add(door2);

            // Handles
            const handleGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.2);
            const handleMaterial = new THREE.MeshStandardMaterial({ color: 0xFFD700 });
            
            const handle1 = new THREE.Mesh(handleGeometry, handleMaterial);
            handle1.rotation.z = Math.PI / 2;
            handle1.position.set(-0.1, 1.25, 0.36);
            group.add(handle1);
            
            const handle2 = new THREE.Mesh(handleGeometry, handleMaterial);
            handle2.rotation.z = Math.PI / 2;
            handle2.position.set(0.1, 1.25, 0.36);
            group.add(handle2);
        }

        function createDesk(group) {
            // Desktop
            const topGeometry = new THREE.BoxGeometry(2, 0.1, 1);
            const topMaterial = new THREE.MeshStandardMaterial({ color: 0x654321 });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.y = 0.75;
            top.castShadow = true;
            group.add(top);

            // Legs
            const legGeometry = new THREE.BoxGeometry(0.1, 0.75, 0.1);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
            
            const positions = [
                [-0.9, 0.375, -0.4],
                [0.9, 0.375, -0.4],
                [-0.9, 0.375, 0.4],
                [0.9, 0.375, 0.4]
            ];
            
            positions.forEach(pos => {
                const leg = new THREE.Mesh(legGeometry, legMaterial);
                leg.position.set(...pos);
                leg.castShadow = true;
                group.add(leg);
            });
        }

        function createChair(group) {
            // Seat
            const seatGeometry = new THREE.BoxGeometry(0.5, 0.1, 0.5);
            const seatMaterial = new THREE.MeshStandardMaterial({ color: 0x8B0000 });
            const seat = new THREE.Mesh(seatGeometry, seatMaterial);
            seat.position.y = 0.5;
            seat.castShadow = true;
            group.add(seat);

            // Backrest
            const backGeometry = new THREE.BoxGeometry(0.5, 0.6, 0.1);
            const back = new THREE.Mesh(backGeometry, seatMaterial);
            back.position.set(0, 0.8, -0.2);
            back.castShadow = true;
            group.add(back);

            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.5);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
            
            const positions = [
                [-0.2, 0.25, -0.2],
                [0.2, 0.25, -0.2],
                [-0.2, 0.25, 0.2],
                [0.2, 0.25, 0.2]
            ];
            
            positions.forEach(pos => {
                const leg = new THREE.Mesh(legGeometry, legMaterial);
                leg.position.set(...pos);
                leg.castShadow = true;
                group.add(leg);
            });
        }

        function createSofa(group) {
            // Base
            const baseGeometry = new THREE.BoxGeometry(3, 0.6, 1);
            const baseMaterial = new THREE.MeshStandardMaterial({ color: 0x4B0082 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.y = 0.3;
            base.castShadow = true;
            group.add(base);

            // Backrest
            const backGeometry = new THREE.BoxGeometry(3, 0.8, 0.3);
            const back = new THREE.Mesh(backGeometry, baseMaterial);
            back.position.set(0, 0.7, -0.35);
            back.castShadow = true;
            group.add(back);

            // Armrests
            const armGeometry = new THREE.BoxGeometry(0.3, 0.5, 1);
            
            const arm1 = new THREE.Mesh(armGeometry, baseMaterial);
            arm1.position.set(-1.35, 0.45, 0);
            arm1.castShadow = true;
            group.add(arm1);
            
            const arm2 = new THREE.Mesh(armGeometry, baseMaterial);
            arm2.position.set(1.35, 0.45, 0);
            arm2.castShadow = true;
            group.add(arm2);
        }

        function createTable(group) {
            // Tabletop
            const topGeometry = new THREE.CylinderGeometry(1, 1, 0.1, 32);
            const topMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.y = 0.75;
            top.castShadow = true;
            group.add(top);

            // Central leg
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.75);
            const legMaterial = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const leg = new THREE.Mesh(legGeometry, legMaterial);
            leg.position.y = 0.375;
            leg.castShadow = true;
            group.add(leg);
        }